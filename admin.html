<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Report Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .login-container h1 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .dashboard {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard.active {
            display: block;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #667eea;
        }

        .logout-btn {
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .card .value {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .table-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
        }

        .export-btn {
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .export-btn.secondary {
            background: #3498db;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 12px 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:hover {
            background: #f8f9ff;
        }

        .view-chart-btn {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 1000px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            font-size: 2em;
            cursor: pointer;
            color: #666;
            background: none;
            border: none;
        }

        .chart-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .chart-wrapper {
            margin-bottom: 30px;
        }

        canvas {
            max-height: 400px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            color: #e74c3c;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div class="login-container" id="loginContainer">
        <h1>Admin Login</h1>
        <div class="form-group">
            <label>User ID</label>
            <input type="text" id="username" placeholder="Enter user ID">
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="password" placeholder="Enter password">
        </div>
        <button class="btn" onclick="login()">Login</button>
        <div class="error" id="loginError"></div>
    </div>

    <!-- Dashboard Section -->
    <div class="dashboard" id="dashboard">
        <div class="header">
            <h1>Research Analytics Dashboard</h1>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="stats-cards">
            <div class="card">
                <h3>Total Respondents</h3>
                <div class="value" id="totalRespondents">0</div>
            </div>
            <div class="card">
                <h3>Total Questions</h3>
                <div class="value" id="totalQuestions">0</div>
            </div>
            <div class="card">
                <h3>Completion Rate</h3>
                <div class="value" id="completionRate">0%</div>
            </div>
        </div>

        <div class="chart-card">
            <h3 style="margin-bottom: 15px;">Respondents by Age Group</h3>
            <canvas id="ageChart"></canvas>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h2>Question Analytics</h2>
                <div class="export-buttons">
                    <button class="export-btn secondary" onclick="exportRawData()">Export Raw Responses</button>
                    <button class="export-btn" onclick="exportStatistics()">Export Statistics</button>
                </div>
            </div>
            <div id="tableContent"></div>
        </div>
    </div>

    <!-- Chart Modal -->
    <div class="modal" id="chartModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Question Analytics</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <div class="chart-controls">
                <div class="form-group">
                    <label>Bin Size</label>
                    <input type="number" id="binSize" value="5" min="1">
                </div>
                <div class="form-group">
                    <label>Min Value</label>
                    <input type="number" id="minValue">
                </div>
                <div class="form-group">
                    <label>Max Value</label>
                    <input type="number" id="maxValue">
                </div>
            </div>
            <button class="btn" onclick="updateCharts()" style="margin-bottom: 20px;">Update Charts</button>

            <div class="chart-wrapper">
                <h3>Box and Whisker Plot</h3>
                <canvas id="boxPlot"></canvas>
            </div>

            <div class="chart-wrapper">
                <h3>Histogram</h3>
                <canvas id="histogram"></canvas>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://sezjmmhrqczrznqgtydn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNlemptbWhycWN6cnpucWd0eWRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NjgxNjksImV4cCI6MjA4MDM0NDE2OX0.jHDxaQ7o2tDqTrrrouGkZNG_4wPtRQA7JmplL3d4_80';

        let submissions = [];
        let questions = [];
        let currentQuestionData = [];
        let boxChart, histChart;

        async function fetchFromSupabase(endpoint) {
            const url = `${SUPABASE_URL}/rest/v1/${endpoint}`;
            const headers = {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json'
            };

            const response = await fetch(url, { headers });
            if (!response.ok) throw new Error('Failed to fetch data');
            return response.json();
        }

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === 'kunal' && password === '1110') {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                loadDashboard();
            } else {
                document.getElementById('loginError').textContent = 'Invalid credentials';
            }
        }

        function logout() {
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').textContent = '';
        }

        async function loadDashboard() {
            try {
                submissions = await fetchFromSupabase('user_submission?select=*');
                questions = await fetchFromSupabase('question_master?select=*&order=question_no.asc');

                console.log('Submissions loaded:', submissions.length);
                console.log('First submission sample:', submissions[0]);
                console.log('Questions loaded:', questions.length);

                updateStats();
                renderAgeChart();
                renderTable();
            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Error loading data: ' + error.message);
            }
        }

        function updateStats() {
            document.getElementById('totalRespondents').textContent = submissions.length;
            document.getElementById('totalQuestions').textContent = questions.length;
            
            let totalAnswers = 0;
            let possibleAnswers = submissions.length * questions.length;
            
            submissions.forEach(sub => {
                for (let i = 1; i <= questions.length; i++) {
                    if (sub[`q${i}`]) totalAnswers++;
                }
            });
            
            const rate = possibleAnswers > 0 ? ((totalAnswers / possibleAnswers) * 100).toFixed(1) : 0;
            document.getElementById('completionRate').textContent = rate + '%';
        }

        function renderAgeChart() {
            const ageGroups = {
                '18-25': 0,
                '26-35': 0,
                '36-45': 0,
                '46-55': 0,
                '56+': 0
            };

            submissions.forEach(sub => {
                if (sub.dob) {
                    const age = new Date().getFullYear() - new Date(sub.dob).getFullYear();
                    if (age <= 25) ageGroups['18-25']++;
                    else if (age <= 35) ageGroups['26-35']++;
                    else if (age <= 45) ageGroups['36-45']++;
                    else if (age <= 55) ageGroups['46-55']++;
                    else ageGroups['56+']++;
                }
            });

            const ctx = document.getElementById('ageChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(ageGroups),
                    datasets: [{
                        data: Object.values(ageGroups),
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#4facfe',
                            '#43e97b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderTable() {
            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Q No</th>
                            <th>Question</th>
                            <th>Respondents</th>
                            <th>Mean</th>
                            <th>Median</th>
                            <th>Mode</th>
                            <th>Max</th>
                            <th>Min</th>
                            <th>Sum</th>
                            <th>Count</th>
                            <th>Variance</th>
                            <th>Std Dev</th>
                            <th>Std Error</th>
                            <th>Skewness</th>
                            <th>Range</th>
                            <th>Kurtosis</th>
                            <th>Conf Level</th>
                            <th>P Value</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${questions.map(q => {
                            const stats = calculateStats(q.question_no);
                            return `
                                <tr>
                                    <td>${q.question_no}</td>
                                    <td>${q.question_text.substring(0, 50)}...</td>
                                    <td>${stats.count}</td>
                                    <td>${stats.mean}</td>
                                    <td>${stats.median}</td>
                                    <td>${stats.mode}</td>
                                    <td>${stats.max}</td>
                                    <td>${stats.min}</td>
                                    <td>${stats.sum}</td>
                                    <td>${stats.count}</td>
                                    <td>${stats.variance}</td>
                                    <td>${stats.stdDev}</td>
                                    <td>${stats.stdError}</td>
                                    <td>${stats.skewness}</td>
                                    <td>${stats.range}</td>
                                    <td>${stats.kurtosis}</td>
                                    <td>${stats.confLevel}</td>
                                    <td>${stats.pValue}</td>
                                    <td><button class="view-chart-btn" onclick="showCharts(${q.question_no}, '${q.question_text.replace(/'/g, "\\'")}')">View Charts</button></td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('tableContent').innerHTML = tableHTML;
        }

        function calculateStats(qNo) {
            const values = [];
            const allResponses = [];
            const textResponses = [];
            
            submissions.forEach(sub => {
                const val = sub[`q${qNo}`];
                if (val !== null && val !== undefined && val !== '') {
                    const trimmedVal = String(val).trim();
                    allResponses.push(trimmedVal);
                    
                    // Try to convert to number
                    const numVal = parseFloat(trimmedVal);
                    if (!isNaN(numVal) && trimmedVal !== '') {
                        values.push(numVal);
                    } else {
                        textResponses.push(trimmedVal);
                    }
                }
            });

            const totalResponses = allResponses.length;

            // If we have numeric values, calculate numeric stats
            if (values.length > 0) {
                const n = values.length;
                const sum = values.reduce((a, b) => a + b, 0);
                const mean = sum / n;
                
                const sorted = [...values].sort((a, b) => a - b);
                const median = n % 2 === 0 ? (sorted[n/2 - 1] + sorted[n/2]) / 2 : sorted[Math.floor(n/2)];
                
                // Calculate mode for numeric values
                const freq = {};
                values.forEach(v => {
                    const key = v.toFixed(2);
                    freq[key] = (freq[key] || 0) + 1;
                });
                const modeKey = Object.keys(freq).reduce((a, b) => freq[a] > freq[b] ? a : b);
                const mode = parseFloat(modeKey);
                
                const variance = n > 1 ? values.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / (n - 1) : 0;
                const stdDev = Math.sqrt(variance);
                const stdError = n > 0 ? stdDev / Math.sqrt(n) : 0;
                
                const skewness = stdDev > 0 ? (values.reduce((acc, val) => acc + Math.pow(val - mean, 3), 0) / n) / Math.pow(stdDev, 3) : 0;
                const kurtosis = stdDev > 0 ? (values.reduce((acc, val) => acc + Math.pow(val - mean, 4), 0) / n) / Math.pow(stdDev, 4) - 3 : 0;
                
                const confLevel = 1.96 * stdError;
                const pValue = 0.05;

                return {
                    count: totalResponses,
                    mean: mean.toFixed(2),
                    median: median.toFixed(2),
                    mode: mode.toFixed(2),
                    max: Math.max(...values).toFixed(2),
                    min: Math.min(...values).toFixed(2),
                    sum: sum.toFixed(2),
                    variance: variance.toFixed(2),
                    stdDev: stdDev.toFixed(2),
                    stdError: stdError.toFixed(2),
                    skewness: skewness.toFixed(2),
                    range: (Math.max(...values) - Math.min(...values)).toFixed(2),
                    kurtosis: kurtosis.toFixed(2),
                    confLevel: confLevel.toFixed(2),
                    pValue: pValue.toFixed(4)
                };
            }
            
            // If only text responses, calculate mode (most frequent)
            if (textResponses.length > 0) {
                const freq = {};
                textResponses.forEach(v => freq[v] = (freq[v] || 0) + 1);
                const mode = Object.keys(freq).reduce((a, b) => freq[a] > freq[b] ? a : b);
                
                return {
                    count: totalResponses,
                    mean: 'Text',
                    median: 'Text',
                    mode: mode.substring(0, 15) + '...',
                    max: 'Text',
                    min: 'Text',
                    sum: 'Text',
                    variance: 'Text',
                    stdDev: 'Text',
                    stdError: 'Text',
                    skewness: 'Text',
                    range: 'Text',
                    kurtosis: 'Text',
                    confLevel: 'Text',
                    pValue: 'Text'
                };
            }

            // No responses at all
            return {
                count: 0,
                mean: 'N/A',
                median: 'N/A',
                mode: 'N/A',
                max: 'N/A',
                min: 'N/A',
                sum: 'N/A',
                variance: 'N/A',
                stdDev: 'N/A',
                stdError: 'N/A',
                skewness: 'N/A',
                range: 'N/A',
                kurtosis: 'N/A',
                confLevel: 'N/A',
                pValue: 'N/A'
            };
        }

        function showCharts(qNo, qText) {
            currentQuestionData = [];
            const allResponses = [];
            
            submissions.forEach(sub => {
                const val = sub[`q${qNo}`];
                if (val !== null && val !== undefined && val !== '') {
                    const trimmedVal = String(val).trim();
                    allResponses.push(trimmedVal);
                    
                    const numVal = parseFloat(trimmedVal);
                    if (!isNaN(numVal) && trimmedVal !== '') {
                        currentQuestionData.push(numVal);
                    }
                }
            });

            console.log(`Question ${qNo} - Total responses:`, allResponses.length);
            console.log(`Question ${qNo} - Numeric responses:`, currentQuestionData.length);
            console.log(`Question ${qNo} - Sample data:`, currentQuestionData.slice(0, 10));

            if (currentQuestionData.length === 0) {
                alert(`No numeric data available for this question.\n\nTotal responses: ${allResponses.length}\nThis question contains text-based answers only.\n\nSample responses:\n${allResponses.slice(0, 5).join('\n')}`);
                return;
            }

            document.getElementById('modalTitle').textContent = `Q${qNo}: ${qText}`;
            document.getElementById('minValue').value = Math.min(...currentQuestionData);
            document.getElementById('maxValue').value = Math.max(...currentQuestionData);
            document.getElementById('chartModal').classList.add('active');
            
            updateCharts();
        }

        function updateCharts() {
            const binSize = parseInt(document.getElementById('binSize').value) || 5;
            const minVal = parseFloat(document.getElementById('minValue').value);
            const maxVal = parseFloat(document.getElementById('maxValue').value);
            
            const filteredData = currentQuestionData.filter(v => v >= minVal && v <= maxVal);
            
            renderBoxPlot(filteredData);
            renderHistogram(filteredData, binSize);
        }

        function renderBoxPlot(data) {
            const sorted = [...data].sort((a, b) => a - b);
            const q1 = sorted[Math.floor(sorted.length * 0.25)];
            const median = sorted[Math.floor(sorted.length * 0.5)];
            const q3 = sorted[Math.floor(sorted.length * 0.75)];
            const min = sorted[0];
            const max = sorted[sorted.length - 1];

            if (boxChart) boxChart.destroy();

            const ctx = document.getElementById('boxPlot').getContext('2d');
            boxChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Box Plot'],
                    datasets: [{
                        label: 'Max',
                        data: [max],
                        backgroundColor: '#667eea'
                    }, {
                        label: 'Q3',
                        data: [q3],
                        backgroundColor: '#764ba2'
                    }, {
                        label: 'Median',
                        data: [median],
                        backgroundColor: '#f093fb'
                    }, {
                        label: 'Q1',
                        data: [q1],
                        backgroundColor: '#4facfe'
                    }, {
                        label: 'Min',
                        data: [min],
                        backgroundColor: '#43e97b'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }

        function renderHistogram(data, binSize) {
            const min = Math.min(...data);
            const max = Math.max(...data);
            const bins = Math.ceil((max - min) / binSize);
            
            const histogram = new Array(bins).fill(0);
            const labels = [];
            
            for (let i = 0; i < bins; i++) {
                const binStart = min + (i * binSize);
                const binEnd = binStart + binSize;
                labels.push(`${binStart.toFixed(1)}-${binEnd.toFixed(1)}`);
            }
            
            data.forEach(val => {
                const binIndex = Math.min(Math.floor((val - min) / binSize), bins - 1);
                histogram[binIndex]++;
            });

            if (histChart) histChart.destroy();

            const ctx = document.getElementById('histogram').getContext('2d');
            histChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Frequency',
                        data: histogram,
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Frequency' }
                        },
                        x: {
                            title: { display: true, text: 'Value Range' }
                        }
                    }
                }
            });
        }

        function closeModal() {
            document.getElementById('chartModal').classList.remove('active');
            if (boxChart) boxChart.destroy();
            if (histChart) histChart.destroy();
        }

        function exportStatistics() {
            let csv = 'Question No,Question,Respondents,Mean,Median,Mode,Max,Min,Sum,Count,Variance,Std Dev,Std Error,Skewness,Range,Kurtosis,Confidence Level,P Value\n';
            
            questions.forEach(q => {
                const stats = calculateStats(q.question_no);
                csv += `${q.question_no},"${q.question_text}",${stats.count},${stats.mean},${stats.median},${stats.mode},${stats.max},${stats.min},${stats.sum},${stats.count},${stats.variance},${stats.stdDev},${stats.stdError},${stats.skewness},${stats.range},${stats.kurtosis},${stats.confLevel},${stats.pValue}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'questionnaire_statistics.csv';
            a.click();
        }

        function exportRawData() {
            // Build header row
            let csv = 'Submission ID,Created At,Name,Email,Gender,DOB,City';
            
            // Add all question headers
            for (let i = 1; i <= 80; i++) {
                const question = questions.find(q => q.question_no === i);
                if (question) {
                    // Escape question text and limit length for header
                    const questionText = question.question_text.substring(0, 100).replace(/"/g, '""');
                    csv += `,"Q${i}: ${questionText}"`;
                } else {
                    csv += `,"Q${i}"`;
                }
            }
            csv += '\n';

            // Add data rows
            submissions.forEach(sub => {
                const row = [
                    sub.id || '',
                    sub.created_at || '',
                    `"${(sub.name || '').replace(/"/g, '""')}"`,
                    `"${(sub.email || '').replace(/"/g, '""')}"`,
                    sub.gender || '',
                    sub.dob || '',
                    `"${(sub.city || '').replace(/"/g, '""')}"`
                ];

                // Add all question responses
                for (let i = 1; i <= 80; i++) {
                    const answer = sub[`q${i}`] || '';
                    // Escape quotes and wrap in quotes
                    row.push(`"${String(answer).replace(/"/g, '""')}"`);
                }

                csv += row.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `questionnaire_raw_data_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
    </script>
</body>
</html>
